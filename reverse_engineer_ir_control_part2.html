<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Reverse engineer IR-remote control - Part 2 (Control the IR-LED)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Basti">

    <!-- Le styles -->
    <link rel="stylesheet" href="/theme/css/bootstrap.dark.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="/theme/css/bootstrap-responsive.dark.css" rel="stylesheet">
        <link href="/theme/css/font-awesome.css" rel="stylesheet">

    <link href="/theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="/theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/theme/images/apple-touch-icon-114x114.png">

    <link href="/" type="application/atom+xml" rel="alternate" title="BuZZ-T's Blog ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/index.html">BuZZ-T's Blog </a>
          <div class="nav-collapse">
            <ul class="nav">
                <li><a href="/pages/about.html">About</a></li>
                <li><a href="/pages/datenschutzerklarung.html">Datenschutzerkl√§rung</a></li>
                <li><a href="/pages/impressum.html">Impressum</a></li>
                          <li class="divider-vertical"></li>
                  <li class="active">
                    <a href="/category/blog.html">
						<i class="icon-folder-open icon-large"></i>Blog
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="/archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Reverse engineer IR-remote control - Part 2 (Control the IR-LED)">
                                        Reverse engineer IR-remote control - Part 2 (Control the IR-LED)
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2022-06-06T00:00:00+02:00">
        <i class="icon-calendar"></i>Mo 06 Juni 2022
</abbr>
<span class="label">By</span>
<a href="/author/basti.html"><i class="icon-user"></i>Basti</a>
<span class="label">Category</span>
<a href="/category/blog.html"><i class="icon-folder-open"></i>Blog</a>.


<span class="label">Tags</span>
	<a href="/tag/reverse-engineering.html"><i class="icon-tag"></i>reverse engineering</a>
	<a href="/tag/home-automation.html"><i class="icon-tag"></i>home automation</a>
</footer><!-- /.post-info -->                </div>
                <p>This is the second post in this series. See <a class="reference external" href="reverse_engineer_ir_control_part1">First Post</a></p>
<p>In this post we gonna have a look how I re-generated the signals, I reverse
engineered in the first post.</p>
<p>I personally prefer a way of generating the signals without doing bitbanging, or
directly trigger a GPIO output of the controller manually.</p>
<p>I worked with <a class="reference external" href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface">SPI</a>  in previous project for my company
and the idea is to use the SPI peripheral in the controler to generate that signal. To be more exact I want
to use the MOSI (Master Out Slave In) Pin for generating the signal.</p>
<p>The advantages would be:</p>
<ul class="simple">
<li>no problems with timing (interrupts on the controller a.s.o.), just trigger an SPI write and everything works in background</li>
<li>portability between different controllers</li>
</ul>
<p>So the basic idea to find a frequency for the SPI bus that allows me to create this signals by sending a combination of one and zeros.</p>
<div class="section" id="playing-arround-with-spi-on-the-esp32-using-the-arduino-eco-system">
<h2>Playing arround with SPI on the ESP32 using the Arduino eco system</h2>
<p>In the ESP32 platform data for the Arduino ecosystem is an example code that shows the usage of
<a class="reference external" href="https://github.com/espressif/arduino-esp32/blob/master/libraries/SPI/examples/SPI_Multiple_Buses/SPI_Multiple_Buses.ino">Multiple SPI Buses</a>
starting with this example I created a small project which just sends out data on the SPI bus.</p>
<p>This is reduced source code for my first test</p>
<div class="section" id="src-code">
<h3>src-code</h3>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">spiClk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"></span>

<span class="n">SPIClass</span><span class="w"> </span><span class="o">*</span><span class="n">vspi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">vspi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SPIClass</span><span class="p">(</span><span class="n">VSPI</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">vspiCommand</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">vspiCommand</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">byte</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b01010101</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">beginTransaction</span><span class="p">(</span><span class="n">SPISettings</span><span class="p">(</span><span class="n">spiClk</span><span class="p">,</span><span class="w"> </span><span class="n">MSBFIRST</span><span class="p">,</span><span class="w"> </span><span class="n">SPI_MODE0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">transfer</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">endTransaction</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Additionally to that I connected the GPIO23 (MOSI of VSPI) and GND of the ESP32 to my LogicAnalyzer.</p>
<p>Building and download downloading the source code show following output</p>
<img alt="Picture from LogicAnalyzer software" src="images/ir_remote_control/SPI_Bus_1MHz.png" style="width: 800px;" />
<p>So when we sending 0b01010101 (0x55) we got a signal that looks like the pulses we saw when analyzing
the IR protocol. But the time in high and low state is still much to short.</p>
<p>The time in high and lowstate is 1 us.</p>
<p>It needs to be 13.5 times longer.</p>
<p>So lets lower the baudrate about the factor 13.5</p>
<p>1000000 / 13.5 = ~74074</p>
<div class="highlight"><pre><span></span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">spiClk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">74074</span><span class="p">;</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
<p>Building and downloading again showed following output from the LogicAnalyzer</p>
<img alt="Picture from LogicAnalyzer software" src="images/ir_remote_control/SPI_Bus_ReducedBaudrate.png" style="width: 800px;" />
<p>No the time in high and low state is 13.5 us.
Great, we got the SPI to build pulses.</p>
<p>Lets make a few more tweaks to the code, instead of sending the 0b01010101 one time, we send it four times</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">spiClk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">74074</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">SPIClass</span><span class="w"> </span><span class="o">*</span><span class="n">vspi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">vspi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SPIClass</span><span class="p">(</span><span class="n">VSPI</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">vspiCommand</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">vspiCommand</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b01010101</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">arrData</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span><span class="w"></span>
<span class="w">            </span><span class="n">memset</span><span class="p">(</span><span class="n">arrData</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">arrData</span><span class="p">));</span><span class="w"></span>

<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="n">arrData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>


<span class="w">            </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">beginTransaction</span><span class="p">(</span><span class="n">SPISettings</span><span class="p">(</span><span class="n">spiClk</span><span class="p">,</span><span class="w"> </span><span class="n">MSBFIRST</span><span class="p">,</span><span class="w"> </span><span class="n">SPI_MODE0</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">writeBytes</span><span class="p">(</span><span class="n">arrData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">arrData</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">endTransaction</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>
<p>Using the source code the LogicAnalyzer showed following output</p>
<img alt="Picture from LogicAnalyzer software" src="images/ir_remote_control/SPI_ShortPulseDetails.png" style="width: 800px;" />
<p>Et voila, we got the pulses in the width and in the count of the &quot;short pulse&quot; from the protocol we analyzed in the
<a class="reference external" href="reverse_engineer_ir_control_part1">First Post</a></p>
<p>We just need the correct break ~1,27 ms (milliseconds) after the pulses.</p>
<p>We can generate the pause (keeping data line low) by sending zeros per SPI. And to see how long the actual pause is
we send a 0xff, this allows us to measure the pause with the LogicAnalyzer.</p>
<p>Lets tweak the code again.</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">spiClk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">74074</span><span class="p">;</span><span class="w"></span>

<span class="n">SPIClass</span><span class="w"> </span><span class="o">*</span><span class="n">vspi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">vspi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SPIClass</span><span class="p">(</span><span class="n">VSPI</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">vspiCommand</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">vspiCommand</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b01010101</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">arrData</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">arrData</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">arrData</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">arrData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">arrData</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">beginTransaction</span><span class="p">(</span><span class="n">SPISettings</span><span class="p">(</span><span class="n">spiClk</span><span class="p">,</span><span class="w"> </span><span class="n">MSBFIRST</span><span class="p">,</span><span class="w"> </span><span class="n">SPI_MODE0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">writeBytes</span><span class="p">(</span><span class="n">arrData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">arrData</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">endTransaction</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Using the source code showed the following results from the LogicAnalyzer</p>
<img alt="Picture from LogicAnalyzer software" src="images/ir_remote_control/SPI_After_ShortPulseDetails.png" style="width: 700px;" />
<p>We got a pause of ~1,29ms, with a period closely to the one we need. The differrence is 20us, we
keep this difference and hope its working :)</p>
<p>Moving the data we generated to a compile defined array, we can generate the following function:</p>
<div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">addShortPulse</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">pData</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data_short_pulse</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">data_short_pulse</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data_short_pulse</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data_short_pulse</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Now we just need to do same procedure to create the &quot;long pulse&quot;. Instead of showing the same procedure
here twice.</p>
<p>Here is just the function that generates the long pulse:</p>
<div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">addLongPulse</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">pData</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data_long_pulse</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">data_long_pulse</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data_long_pulse</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data_long_pulse</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Using that both function we can generate our commands. For triggering the functions of the
ceiling fan:</p>
<div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">FanCommand</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">LightOn</span><span class="p">,</span><span class="w"> </span><span class="n">LightOff</span><span class="p">,</span><span class="w"> </span><span class="n">Fan0</span><span class="p">,</span><span class="w"> </span><span class="n">Fan1</span><span class="p">,</span><span class="w"> </span><span class="n">Fan2</span><span class="p">,</span><span class="w"> </span><span class="n">Fan3</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">prepareTxBuffer</span><span class="p">(</span><span class="n">FanCommand</span><span class="w"> </span><span class="n">eCommand</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">tx_buffer</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">//command preemble - two &quot;long pulses&quot;</span>
<span class="w">        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">eCommand</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">LightOff</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">LightOn</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">Fan0</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">Fan1</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">Fan2</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">Fan3</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nLength</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>We can use this function for generating the tx_buffer to send a command</p>
<div class="highlight"><pre><span></span><span class="n">byte</span><span class="w"> </span><span class="n">tx_buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w"></span>
<span class="n">memset</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">);</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">nSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prepareTxBuffer</span><span class="p">(</span><span class="n">FanCommand</span><span class="o">::</span><span class="n">LightOff</span><span class="p">,</span><span class="w"> </span><span class="n">tx_buffer</span><span class="p">);</span><span class="w"></span>

<span class="n">vspi</span><span class="o">-&gt;</span><span class="n">beginTransaction</span><span class="p">(</span><span class="n">SPISettings</span><span class="p">(</span><span class="n">SPI_CLOCK</span><span class="p">,</span><span class="w"> </span><span class="n">MSBFIRST</span><span class="p">,</span><span class="w"> </span><span class="n">SPI_MODE0</span><span class="p">));</span><span class="w"></span>
<span class="n">vspi</span><span class="o">-&gt;</span><span class="n">writeBytes</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">nSize</span><span class="p">);</span><span class="w"></span>
<span class="n">vspi</span><span class="o">-&gt;</span><span class="n">endTransaction</span><span class="p">();</span><span class="w"></span>
</pre></div>
<p>But sending the command for switching out the light only once, hasn't switched of
light.</p>
<p>Looking at the signals capture in post, we can see that the pulse were send multiples times
in short row. With a delay of 8ms between so I decided also to do so.</p>
<p>Which lead me to my working loop() function:</p>
<div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">byte</span><span class="w"> </span><span class="n">tx_buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prepareTxBuffer</span><span class="p">(</span><span class="n">FanCommand</span><span class="o">::</span><span class="n">LightOff</span><span class="p">,</span><span class="w"> </span><span class="n">tx_buffer</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">lastMillis</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">beginTransaction</span><span class="p">(</span><span class="n">SPISettings</span><span class="p">(</span><span class="n">SPI_CLOCK</span><span class="p">,</span><span class="w"> </span><span class="n">MSBFIRST</span><span class="p">,</span><span class="w"> </span><span class="n">SPI_MODE0</span><span class="p">));</span><span class="w"></span>

<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUMBER_OF_SENDS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">writeBytes</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">nSize</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">endTransaction</span><span class="p">();</span><span class="w"></span>

<span class="w">                </span><span class="n">lastMillis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Every command is now working.</p>
<p>Thats it for the second Part of &quot;Reverse engineer IR-remote control&quot;.</p>
<p>In the next post we will see how we can tweak the project to use more modern C++ features.
A few modern smell has already been added during development.</p>
<p>And finally here is the complete source code for the ESP32 in the Arduino framework.</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;esp32_ventilator_ir.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>

<span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">FanCommand</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">LightOn</span><span class="p">,</span><span class="w"> </span><span class="n">LightOff</span><span class="p">,</span><span class="w"> </span><span class="n">Fan0</span><span class="p">,</span><span class="w"> </span><span class="n">Fan1</span><span class="p">,</span><span class="w"> </span><span class="n">Fan2</span><span class="p">,</span><span class="w"> </span><span class="n">Fan3</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">SPIClass</span><span class="w"> </span><span class="o">*</span><span class="n">vspi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lastMillis</span><span class="p">;</span><span class="w"></span>

<span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">SPI_CLOCK</span><span class="w"></span>
<span class="p">{</span><span class="w"> </span><span class="mi">74074</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">NUMBER_OF_SENDS</span><span class="w"></span>
<span class="p">{</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">vspi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SPIClass</span><span class="p">(</span><span class="n">VSPI</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="n">lastMillis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">addLongPulse</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">pData</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data_long_pulse</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">data_long_pulse</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data_long_pulse</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data_long_pulse</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">addShortPulse</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">pData</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data_short_pulse</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mh">0x55</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">data_short_pulse</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data_short_pulse</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data_short_pulse</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">prepareTxBuffer</span><span class="p">(</span><span class="n">FanCommand</span><span class="w"> </span><span class="n">eCommand</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">tx_buffer</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">//command preemble - two &quot;long pulses&quot;</span>
<span class="w">        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">eCommand</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">LightOff</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">LightOn</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">Fan0</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">Fan1</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">Fan2</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">FanCommand</span><span class="o">::</span><span class="no">Fan3</span><span class="p">:</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addShortPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="n">nLength</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">addLongPulse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_buffer</span><span class="p">[</span><span class="n">nLength</span><span class="p">]);</span><span class="w"></span>
<span class="w">                        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nLength</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">byte</span><span class="w"> </span><span class="n">tx_buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prepareTxBuffer</span><span class="p">(</span><span class="n">FanCommand</span><span class="o">::</span><span class="n">LightOff</span><span class="p">,</span><span class="w"> </span><span class="n">tx_buffer</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">lastMillis</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">beginTransaction</span><span class="p">(</span><span class="n">SPISettings</span><span class="p">(</span><span class="n">SPI_CLOCK</span><span class="p">,</span><span class="w"> </span><span class="n">MSBFIRST</span><span class="p">,</span><span class="w"> </span><span class="n">SPI_MODE0</span><span class="p">));</span><span class="w"></span>

<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUMBER_OF_SENDS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">writeBytes</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">nSize</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>

<span class="w">                </span><span class="n">vspi</span><span class="o">-&gt;</span><span class="n">endTransaction</span><span class="p">();</span><span class="w"></span>

<span class="w">                </span><span class="n">lastMillis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>

                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-home icon-large"></i> social</h4></li>
<li><a href="/" rel="alternate"><i class="icon-bookmark icon-large"></i>atom feed</a></li>
    <li><a href="https://mastodon.social/@seho"><i class="icon-Mastodon-sign icon-large"></i>Mastodon</a></li>
    <li><a href="https://github.com/seho85"><i class="icon-Github-sign icon-large"></i>Github</a></li>
    <li><a href="https://discordapp.com/users/931233284736815105"><i class="icon-Discord-sign icon-large"></i>Discord</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="/category/blog.html">
    <i class="icon-folder-open icon-large"></i>Blog
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>
<li class="tag-[<pelican.contents.Article object at 0x7f4a1af392a0>, <pelican.contents.Article object at 0x7f4a1b8d27d0>, <pelican.contents.Article object at 0x7f4a1ae4e050>]">
    <a href="/tag/klipper.html">
        <i class="icon-tag icon-large"></i>Klipper
    </a>
</li>
<li class="tag-[<pelican.contents.Article object at 0x7f4a1af392a0>, <pelican.contents.Article object at 0x7f4a1b8d27d0>, <pelican.contents.Article object at 0x7f4a1ae4e050>]">
    <a href="/tag/3d-printing.html">
        <i class="icon-tag icon-large"></i>3D Printing
    </a>
</li>
<li class="tag-[<pelican.contents.Article object at 0x7f4a1af392a0>, <pelican.contents.Article object at 0x7f4a1b8d27d0>]">
    <a href="/tag/raspberry-pi.html">
        <i class="icon-tag icon-large"></i>Raspberry Pi
    </a>
</li>
<li class="tag-[<pelican.contents.Article object at 0x7f4a1af392a0>, <pelican.contents.Article object at 0x7f4a1b8d27d0>]">
    <a href="/tag/pwm.html">
        <i class="icon-tag icon-large"></i>PWM
    </a>
</li>
<li class="tag-[<pelican.contents.Article object at 0x7f4a1ae4e050>]">
    <a href="/tag/raspberry-pi-pico.html">
        <i class="icon-tag icon-large"></i>Raspberry Pi Pico
    </a>
</li>
<li class="tag-[<pelican.contents.Article object at 0x7f4a1b943010>, <pelican.contents.Article object at 0x7f4a1af38b80>]">
    <a href="/tag/reverse-engineering.html">
        <i class="icon-tag icon-large"></i>reverse engineering
    </a>
</li>
<li class="tag-[<pelican.contents.Article object at 0x7f4a1b943010>, <pelican.contents.Article object at 0x7f4a1af38b80>]">
    <a href="/tag/home-automation.html">
        <i class="icon-tag icon-large"></i>home automation
    </a>
</li>
<li class="tag-[<pelican.contents.Article object at 0x7f4a1b08e800>]">
    <a href="/tag/awesome_wm.html">
        <i class="icon-tag icon-large"></i>awesome_wm
    </a>
</li>
<li class="tag-[<pelican.contents.Article object at 0x7f4a1b08e800>]">
    <a href="/tag/virtualbox.html">
        <i class="icon-tag icon-large"></i>VirtualBox
    </a>
</li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is based on <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->



    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/theme/js/jquery-1.7.2.min.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>
  </body>
</html>